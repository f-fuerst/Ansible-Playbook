---
- hosts: localhost
  connection: local
  become: true

  tasks:
  - name: Install Snapper
    ansible.builtin.dnf:
      name:
        - snapper
        - python3-dnf-plugin-snapper
      state: present

  - name: Unmount /.snapshots
    ansible.posix.mount:
      path: /.snapshots
      state: unmounted

  - name: Remove /.snapshots
    ansible.builtin.file:
      path: /.snapshots
      state: absent

  - name: Create snapper configuration for root
    ansible.builtin.command: snapper -c root create-config /
    register: snapper_create_config
    changed_when: snapper_create_config.rc == 0

  - name: Delete /.snapshots subvolume
    ansible.builtin.command: btrfs subvolume delete /.snapshots
    register: snapper_delete_subvolume
    changed_when: snapper_delete_subvolume.rc == 0

  - name: Create /.snapshots directory
    ansible.builtin.file:
      path: /.snapshots
      state: directory
      mode: 0644
      owner: root
      group: zar

  - name: Reload systemd daemon
    ansible.builtin.systemd:
      daemon_reload: true

  - name: Mount all
    ansible.builtin.command: mount -a
    register: mount
    changed_when: mount.rc == 0

  - name: Enable snapshot booting
    ansible.builtin.lineinfile:
      path: /etc/default/grub
      line: 'SUSE_BTRFS_SNAPSHOT_BOOTING="true"'
      insertafter: EOF
      state: present

  - name: Update grub.cfg
    ansible.builtin.command: grub2-mkconfig -o /boot/grub2/grub.cfg
    register: grub2_config
    changed_when: grub2_config.rc == 0

  - name: Modify grub.cfg in EFI directory
    ansible.builtin.lineinfile:
      path: /boot/efi/EFI/fedora/grub.cfg
      line: 'btrfs_relative_path="yes"'
      insertbefore: BOF
      state: present

  - name: Add username to snapper's root config
    ansible.builtin.command: snapper -c root set-config ALLOW_USERS=zar SYNC_ACL=yes
    register: snapper_useradd
    changed_when: snapper_useradd.rc == 0

  - name: Disable hidden grub menu
    ansible.builtin.command: grub2-editenv - unset menu_auto_hide
    register: grub_hide
    changed_when: grub_hide.rc == 0

  - name: Clone grub-btrfs repo
    ansible.builtin.git:
      repo: 'https://github.com/Antynea/grub-btrfs.git'
      dest: /home/zar/Downloads/grub-btrfs
      version: c78bd257849bef35eac02d6f53abd5ee0be35e62

  - name: Install grub-btrfs
    community.general.make:
      chdir: /home/zar/Downloads/grub-btrfs
      target: install

  - name: Change grub-btrfs config
    ansible.builtin.copy:
      dest: /etc/default/grub-btrfs/config
      src: "{{ playbook_dir }}/Files/config"
      mode: 0644

  - name: Update grub.cfg again
    ansible.builtin.command: grub2-mkconfig -o /boot/grub2/grub.cfg
    register: grub2_config_btrfs
    changed_when: grub2_config_btrfs.rc == 0

  - name: Enable grub-btrfsd service
    ansible.builtin.systemd:
      name: grub-btrfs.path
      masked: no
      enabled: yes
      state: started
